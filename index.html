<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OnlyPan — Admin + Tienda</title>
  <style>
    /* Estilo funcional y simple (mejoramos luego) */
    :root{--bg:#fff8f1;--accent:#c77b39;--muted:#6b6b6b;}
    body{font-family:Inter,system-ui,Arial;margin:0;background:var(--bg);color:#222}
    header{display:flex;justify-content:space-between;align-items:center;padding:18px 24px;background:#fff;box-shadow:0 1px 6px rgba(0,0,0,.04)}
    h1{margin:0;font-size:20px}
    .btn{background:var(--accent);color:#fff;padding:.5rem .9rem;border-radius:8px;border:none;cursor:pointer;}
    main{padding:18px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
    .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.04)}
    .card img{width:100%;height:140px;object-fit:cover;border-radius:8px}
    .admin-floating{position:fixed;right:18px;bottom:18px}
    /* Modal simple */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:50}
    .modal .box{background:#fff;padding:18px;border-radius:10px;width:520px;max-width:94%}
    .row{display:flex;gap:8px;margin-bottom:8px}
    input,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #eee}
    .hidden{display:none}
    .small{width:120px}
    .prod-list{margin-top:12px}
    .prod-item{display:flex;gap:8px;align-items:center;padding:8px;background:#fff;border-radius:8px;margin-bottom:8px}
    .prod-item img{width:72px;height:52px;object-fit:cover;border-radius:6px}
    .link{background:none;border:0;color:var(--accent);cursor:pointer}
    footer{padding:16px;text-align:center;color:var(--muted)}
    .muted{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <header>
    <h1>OnlyPan</h1>
    <div>
      <button id="openLogin" class="btn">Admin</button>
    </div>
  </header>

  <main>
    <h2>Productos</h2>
    <p class="muted">Los productos se cargan desde Firestore en tiempo real.</p>
    <section id="productsGrid" class="grid" aria-live="polite">
      <!-- productos se renderizan aquí -->
    </section>
  </main>

  <footer>
    © OnlyPan — Creado por tu equipo
  </footer>

  <!-- Modal Login / Admin -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="box">
      <!-- Login -->
      <div id="loginBox">
        <h3>Acceso administrador</h3>
        <div class="row"><input id="loginEmail" type="email" value="admin@onlypan.store" placeholder="Correo"></div>
        <div class="row"><input id="loginPass" type="password" placeholder="Contraseña"></div>
        <div class="row"><button id="loginBtn" class="btn">Iniciar sesión</button>
                       <button id="closeModalBtn" class="link">Cancelar</button></div>
        <p id="loginMsg" class="muted"></p>
      </div>

      <!-- Panel Admin -->
      <div id="adminBox" class="hidden">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>Panel Admin</h3>
          <div>
            <button id="signOutBtn" class="link">Cerrar sesión</button>
          </div>
        </div>

        <hr>

        <h4>Agregar / Editar producto</h4>
        <div class="row"><input id="f_titulo" placeholder="Título"></div>
        <div class="row"><input id="f_precio" type="number" placeholder="Precio"></div>
        <div class="row"><input id="f_imagen" placeholder="URL imagen"></div>
        <div class="row"><textarea id="f_descripcion" rows="3" placeholder="Descripción"></textarea></div>
        <div class="row">
          <button id="saveProductBtn" class="btn">Guardar producto</button>
          <button id="cancelEditBtn" class="link">Cancelar edición</button>
        </div>

        <h4 style="margin-top:14px">Productos en base</h4>
        <div id="prodList" class="prod-list">
          <!-- lista de productos con botones editar / borrar -->
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + app logic -->
  <script type="module">
    /* ---------------------------
       Firebase config (tu proyecto)
       --------------------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, updateDoc, deleteDoc, doc,
      onSnapshot, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDMwg3EKqadonXQKafVEGeaZ9Bb92li6JU",
      authDomain: "onlypan-2b80b.firebaseapp.com",
      projectId: "onlypan-2b80b",
      storageBucket: "onlypan-2b80b.firebasestorage.app",
      messagingSenderId: "61969045493",
      appId: "1:61969045493:web:38e182d708b52273ac32bc",
      measurementId: "G-W0RDF2CQM0"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI references
    const modal = document.getElementById('modal');
    const openLogin = document.getElementById('openLogin');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const loginBox = document.getElementById('loginBox');
    const adminBox = document.getElementById('adminBox');
    const loginBtn = document.getElementById('loginBtn');
    const loginEmail = document.getElementById('loginEmail');
    const loginPass = document.getElementById('loginPass');
    const loginMsg = document.getElementById('loginMsg');

    const prodGrid = document.getElementById('productsGrid');

    // Admin form
    const f_titulo = document.getElementById('f_titulo');
    const f_precio = document.getElementById('f_precio');
    const f_imagen = document.getElementById('f_imagen');
    const f_descripcion = document.getElementById('f_descripcion');
    const saveProductBtn = document.getElementById('saveProductBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const prodList = document.getElementById('prodList');
    const signOutBtn = document.getElementById('signOutBtn');

    // state
    let editingId = null;
    const COLLECTION = "productos"; // <-- nombre de la colección

    // open modal
    openLogin.addEventListener('click', ()=> { modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); });
    closeModalBtn.addEventListener('click', closeModal);

    function closeModal(){
      modal.style.display='none';
      modal.setAttribute('aria-hidden','true');
      loginMsg.textContent = '';
    }

    // Login
    loginBtn.addEventListener('click', async ()=>{
      loginMsg.textContent = 'Iniciando...';
      try {
        await signInWithEmailAndPassword(auth, loginEmail.value.trim(), loginPass.value);
        loginMsg.textContent = '';
      } catch(e) {
        console.error(e);
        loginMsg.textContent = 'Error al iniciar sesión. Revisa correo/contraseña.';
      }
    });

    // Sign out
    signOutBtn.addEventListener('click', async ()=>{
      await signOut(auth);
    });

    // Auth state
    onAuthStateChanged(auth, user => {
      if(user && user.email){
        // mostrar panel admin
        loginBox.classList.add('hidden');
        adminBox.classList.remove('hidden');
        // cargar lista de productos editable
        setupAdminRealtime();
      } else {
        // mostrar login
        loginBox.classList.remove('hidden');
        adminBox.classList.add('hidden');
      }
    });

    /* -----------------------
       Mostrar productos públicos
       ----------------------- */
    function renderProductCard(p){
      const tpl = document.createElement('article');
      tpl.className = 'card';
      const img = p.imagen ? `<img src="${escapeHtml(p.imagen)}" alt="${escapeHtml(p.titulo)}">` : '';
      tpl.innerHTML = `
        ${img}
        <h3>${escapeHtml(p.titulo)}</h3>
        <p class="muted">${escapeHtml(p.descripcion)}</p>
        <div style="font-weight:700;margin-top:8px">$${escapeHtml(p.precio)}</div>
      `;
      return tpl;
    }

    // real-time public list
    const q = query(collection(db, COLLECTION), orderBy('titulo'));
    onSnapshot(q, snapshot => {
      prodGrid.innerHTML = '';
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        prodGrid.appendChild(renderProductCard(data));
      });
    });

    /* -----------------------
       Admin realtime (editable)
       ----------------------- */
    function setupAdminRealtime(){
      // listen to all items
      onSnapshot(collection(db, COLLECTION), snapshot => {
        prodList.innerHTML = '';
        snapshot.forEach(async docSnap => {
          const data = docSnap.data();
          const id = docSnap.id;
          const node = document.createElement('div');
          node.className = 'prod-item';
          node.innerHTML = `
            <img src="${escapeHtml(data.imagen||'')}" alt="">
            <div style="flex:1;text-align:left">
              <strong>${escapeHtml(data.titulo)}</strong>
              <div class="muted">$${escapeHtml(data.precio)}</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px">
              <button class="link" data-edit="${id}">Editar</button>
              <button class="link" data-del="${id}">Eliminar</button>
            </div>
          `;
          prodList.appendChild(node);
        });

        // attach handlers (delegation)
        prodList.querySelectorAll('button[data-edit]').forEach(b=>{
          b.onclick = async ()=> {
            const id = b.getAttribute('data-edit');
            // load doc
            const d = await (await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js")).getDoc(doc(db, COLLECTION, id));
            const val = d.data();
            editingId = id;
            f_titulo.value = val.titulo || '';
            f_precio.value = val.precio || '';
            f_imagen.value = val.imagen || '';
            f_descripcion.value = val.descripcion || '';
            saveProductBtn.textContent = 'Actualizar';
          };
        });
        prodList.querySelectorAll('button[data-del]').forEach(b=>{
          b.onclick = async ()=> {
            const id = b.getAttribute('data-del');
            if(confirm('Eliminar producto?')) {
              await deleteDoc(doc(db, COLLECTION, id));
            }
          };
        });
      });
    }

    // Guardar / actualizar producto
    saveProductBtn.addEventListener('click', async ()=>{
      const titulo = f_titulo.value.trim();
      const precio = Number(f_precio.value) || 0;
      const imagen = f_imagen.value.trim();
      const descripcion = f_descripcion.value.trim();
      if(!titulo){ alert('El título es obligatorio'); return; }

      if(editingId){
        // update
        await updateDoc(doc(db, COLLECTION, editingId), { titulo, precio, imagen, descripcion });
        editingId = null;
        saveProductBtn.textContent = 'Guardar producto';
      } else {
        // add
        await addDoc(collection(db, COLLECTION), { titulo, precio, imagen, descripcion });
      }
      // limpiar formulario
      f_titulo.value=''; f_precio.value=''; f_imagen.value=''; f_descripcion.value='';
    });

    cancelEditBtn.addEventListener('click', ()=>{
      editingId = null;
      f_titulo.value=''; f_precio.value=''; f_imagen.value=''; f_descripcion.value='';
      saveProductBtn.textContent = 'Guardar producto';
    });

    /* -----------------------
       Helpers
       ----------------------- */
    function escapeHtml(s=''){
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
    }
  </script>
</body>
</html>
